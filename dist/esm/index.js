// src/ai.ts
function aiTurn(aiPlayer, targetPlayer) {
  if (aiPlayer.placingShips) {
    return;
  } else if (!aiPlayer.placingShips) {
    const legalMoves = targetPlayer.board.getVacantTiles();
    const chooseTarget = Math.floor(Math.random() * legalMoves.length);
    const target = legalMoves[chooseTarget];
    console.log(`${target.x}, ${target.y}`);
    aiPlayer.placeAttack(targetPlayer, target.x, target.y);
  }
}

// src/ship.ts
var Ship = class {
  constructor(type, size) {
    this.type = "small";
    this.hits = 0;
    this.isSunk = () => {
      return this.hits >= this.size ? true : false;
    };
    this.size = size;
    this.type = type;
    this.key = crypto.randomUUID();
  }
  takeHit() {
    this.hits++;
  }
};

// src/gameboard.ts
var Tile = class {
  constructor(x, y, occupied = false, hit = false, shipKey) {
    this.x = x;
    this.y = y;
    this.occupied = occupied;
    this.hit = hit;
    this.shipKey = shipKey;
  }
};
var GameBoard = class {
  constructor(size) {
    this.gameBoard = [];
    this.activeShips = [];
    for (let x = 0; x < size; x++) {
      for (let y = 0; y < size; y++) {
        this.gameBoard.push(new Tile(x, y));
      }
    }
  }
  placementGrid(startTile, shipSize) {
    const tilesToCheck = [];
    let currentTile = startTile;
    if (tilesToCheck.length === 0) {
      tilesToCheck.push(currentTile);
    }
    while (shipSize > tilesToCheck.length) {
      let newCheckedTile = this.gameBoard.find((newCheckedTile2) => newCheckedTile2.x === currentTile.x && newCheckedTile2.y === currentTile.y + 1);
      if (newCheckedTile) {
        currentTile = newCheckedTile;
        tilesToCheck.push(currentTile);
      } else
        return [];
    }
    return tilesToCheck;
  }
  placeShip(type, size, startTile) {
    const placementArea = this.placementGrid(startTile, size);
    if (placementArea.length === 0) {
      return false;
    } else if (placementArea.some((tile) => tile.occupied)) {
      return false;
    } else {
      const shipToPlace = new Ship(type, size);
      placementArea.forEach((tile) => {
        tile.occupied = true;
        tile.shipKey = shipToPlace.key;
      });
      this.activeShips.push(shipToPlace);
    }
    return true;
  }
  receiveAttack(attackedTile) {
    if (attackedTile.hit) {
      return false;
    } else if (attackedTile.occupied) {
      attackedTile.hit = true;
      if (attackedTile.shipKey) {
        const attackedShip = this.findShipFromKey(attackedTile.shipKey);
        if (attackedShip)
          attackedShip.takeHit();
      }
    } else
      attackedTile.hit = true;
    return true;
  }
  findTile(x, y) {
    return this.gameBoard.find((tile) => tile.x == x && tile.y == y);
  }
  findShipFromKey(keyToFind) {
    const foundShip = this.activeShips.find((ship) => ship.key === keyToFind);
    return foundShip;
  }
  checkIfAllSunk() {
    return this.activeShips.every((ship) => ship.isSunk());
  }
  getVacantTiles() {
    return this.gameBoard.filter((tile) => !tile.hit);
  }
  isOccupied(x, y) {
    const target = this.findTile(x, y);
    if (target)
      target.occupied ? true : false;
  }
};

// src/player.ts
var Player = class {
  constructor(name, human = true, takingTurn = true, shipsAvailable = [{ type: "tiny", size: 1 }, { type: "small", size: 2 }], board = new GameBoard(9), placingShips = true) {
    this.name = name;
    this.human = human;
    this.takingTurn = takingTurn;
    this.shipsAvailable = shipsAvailable;
    this.board = board;
    this.placingShips = placingShips;
  }
  placeAttack(enemyPlayer, x, y) {
    const target = enemyPlayer.board.findTile(x, y);
    if (target && !target.hit) {
      enemyPlayer.board.receiveAttack(target);
      this.takingTurn = false;
      enemyPlayer.setTurn();
      return true;
    } else {
      return false;
    }
  }
  setTurn() {
    this.takingTurn = true;
  }
  placeShip(x, y) {
    if (this.placingShips) {
      if (this.shipsAvailable.length === 0) {
        this.shipBeingPlaced = void 0;
        this.placingShips = false;
        return false;
      }
      const shipToPlace = this.shipsAvailable.pop();
      this.shipBeingPlaced = shipToPlace;
      const target = this.board.findTile(x, y);
      if (target && shipToPlace) {
        this.board.placeShip(shipToPlace.type, shipToPlace.size, target);
        if (this.shipsAvailable.length === 0) {
          this.shipBeingPlaced = void 0;
          this.placingShips = false;
        }
        return true;
      }
    } else
      return false;
  }
};

// src/game.ts
var P1 = new Player("P1");
var P2 = new Player("P2", false, false);
var winner = "TBC";
var gameInPlay = true;
function setupGame() {
  P1 = new Player("P1");
  P2 = new Player("P2", false, false);
  gameInPlay = true;
  P2.placeShip(1, 1);
  P2.placeShip(2, 2);
  P2.placingShips = false;
}
var getCurrentPlayer = () => {
  if (P1.takingTurn && !P2.takingTurn) {
    return P1;
  }
  if (P2.takingTurn && !P1.takingTurn) {
    return P2;
  }
};
var getEnemyPlayer = () => {
  if (P1.takingTurn && !P2.takingTurn) {
    return P2;
  }
  if (P2.takingTurn && !P1.takingTurn) {
    return P1;
  }
};
function getP1ShipsAvailable() {
  return P1.shipsAvailable;
}
function getP2ShipsAvailable() {
  return P2.shipsAvailable;
}
function handleClick(boardName, x, y) {
  var _a;
  const currentPlayer = getCurrentPlayer();
  const enemyPlayer = getEnemyPlayer();
  if (boardName === currentPlayer.name) {
    if (!currentPlayer.placingShips) {
      return false;
    } else {
      currentPlayer.placeShip(x, y);
      return true;
    }
  }
  if (boardName === enemyPlayer.name && !currentPlayer.placingShips) {
    if ((_a = enemyPlayer.board.findTile(x, y)) == null ? void 0 : _a.hit)
      return false;
    currentPlayer.placeAttack(enemyPlayer, x, y);
    checkWinner();
    if (gameInPlay && !enemyPlayer.human) {
      aiTurn(enemyPlayer, currentPlayer);
    }
    return true;
  }
}
function checkWinner() {
  if (!P1.board.checkIfAllSunk() && !P2.board.checkIfAllSunk()) {
    gameInPlay = true;
    return false;
  } else if (P1.board.checkIfAllSunk() === true) {
    winner = P2.name;
    gameInPlay = false;
    return winner;
  } else if (P2.board.checkIfAllSunk() === true) {
    winner = P1.name;
    gameInPlay = false;
    return winner;
  } else {
    gameInPlay = true;
    return false;
  }
}
function getP1Board() {
  return P1.board.gameBoard;
}
function getP2Board() {
  return P2.board.gameBoard;
}
function getShipBeingPlaced() {
  const currentPlayer = getCurrentPlayer();
  if (currentPlayer && currentPlayer.placingShips)
    return currentPlayer.shipBeingPlaced;
}

// src/control.ts
var P1Frame = document.getElementById("P1Frame");
var P2Frame = document.getElementById("P2Frame");
function createTile(owner, tile) {
  const newTile = document.createElement("div");
  newTile.id = `${owner}-${tile.x}-${tile.y}`;
  if (owner === "P1" && tile.occupied && !tile.hit) {
    newTile.className = "tile myship";
  } else if (tile.hit && !tile.occupied) {
    newTile.className = "tile miss";
    newTile.innerText = "x";
  } else if (tile.hit && tile.occupied) {
    newTile.className = "tile hit";
  } else {
    newTile.className = "tile";
  }
  newTile.addEventListener("click", () => {
    if (gameInPlay) {
      handleClick(owner, tile.x, tile.y);
      refreshBoards();
      refreshHarbours();
    }
  });
  return newTile;
}
function refreshBoards() {
  document.body.style.cursor = "none";
  const P1Board = getP1Board();
  const P2Board = getP2Board();
  P1Frame.innerHTML = "";
  P1Board.forEach((tile) => {
    const newTile = createTile("P1", tile);
    P1Frame.appendChild(newTile);
  });
  P2Frame.innerHTML = "";
  P2Board.forEach((tile) => {
    const newTile = createTile("P2", tile);
    P2Frame.appendChild(newTile);
  });
  document.body.style.cursor = "auto";
}
function refreshHarbours() {
  const P1Ships = getP1ShipsAvailable();
  const P2Ships = getP2ShipsAvailable();
  const P1Harbour = document.getElementById("P1Harbour");
  P1Harbour.innerHTML = "<h4>Harbour (ships to place)</h4>";
  const P2Harbour = document.getElementById("P2Harbour");
  P2Harbour.innerHTML = "<h4>Harbour</h4>";
  P1Ships.forEach((ship) => {
    const newShipDiv = document.createElement("div");
    newShipDiv.innerText = `${ship.type} (${ship.size})`;
    if (ship == getShipBeingPlaced()) {
      newShipDiv.className = "harbourShip currentShip";
    } else {
      newShipDiv.className = "harbourShip";
    }
    P1Harbour.appendChild(newShipDiv);
  });
  P2Ships.forEach((ship) => {
    const newShipDiv = document.createElement("div");
    newShipDiv.innerText = `${ship.type} (${ship.size})`;
    newShipDiv.className = "harbourShip";
    P2Harbour.appendChild(newShipDiv);
  });
}

// src/index.ts
setupGame();
refreshBoards();
refreshHarbours();
//# sourceMappingURL=out.js.map
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9haS50cyIsIi4uLy4uL3NyYy9zaGlwLnRzIiwiLi4vLi4vc3JjL2dhbWVib2FyZC50cyIsIi4uLy4uL3NyYy9wbGF5ZXIudHMiLCIuLi8uLi9zcmMvZ2FtZS50cyIsIi4uLy4uL3NyYy9jb250cm9sLnRzIiwiLi4vLi4vc3JjL2luZGV4LnRzIl0sIm5hbWVzIjpbIm5ld0NoZWNrZWRUaWxlIl0sIm1hcHBpbmdzIjoiO0FBRU8sU0FBUyxPQUFPLFVBQWtCLGNBQXNCO0FBQzNELE1BQUksU0FBUyxjQUFjO0FBQ3ZCO0FBQUEsRUFDSixXQUNTLENBQUMsU0FBUyxjQUFjO0FBQzdCLFVBQU0sYUFBYSxhQUFhLE1BQU0sZUFBZTtBQUNyRCxVQUFNLGVBQWUsS0FBSyxNQUFNLEtBQUssT0FBTyxJQUFJLFdBQVcsTUFBTTtBQUNqRSxVQUFNLFNBQVMsV0FBVyxZQUFZO0FBQ3RDLFlBQVEsSUFBSSxHQUFHLE9BQU8sQ0FBQyxLQUFLLE9BQU8sQ0FBQyxFQUFFO0FBQ3RDLGFBQVMsWUFBWSxjQUFjLE9BQU8sR0FBRyxPQUFPLENBQUM7QUFBQSxFQUN6RDtBQUNKOzs7QUNSTyxJQUFNLE9BQU4sTUFBVztBQUFBLEVBTWQsWUFBWSxNQUFjLE1BQWM7QUFMeEMsZ0JBQWU7QUFFZixnQkFBZTtBQVNmLFNBQU8sU0FBUyxNQUFNO0FBQUUsYUFBTyxLQUFLLFFBQVEsS0FBSyxPQUFPLE9BQU87QUFBQSxJQUFNO0FBTGpFLFNBQUssT0FBTztBQUNaLFNBQUssT0FBTztBQUNaLFNBQUssTUFBTSxPQUFPLFdBQVc7QUFBQSxFQUNqQztBQUFBLEVBSU8sVUFBVTtBQUNiLFNBQUs7QUFBQSxFQUNUO0FBQ0o7OztBQ3BCTyxJQUFNLE9BQU4sTUFBVztBQUFBLEVBRWQsWUFDVyxHQUNBLEdBQ0EsV0FBb0IsT0FDcEIsTUFBZSxPQUNmLFNBQWtCO0FBSmxCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFBQSxFQUFvQjtBQUNuQztBQUVPLElBQU0sWUFBTixNQUFnQjtBQUFB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VyxZQUFZLEdBQUcsS0FBSyxJQUFJLEtBQUssS0FBSyxJQUFJO0FBQ2pELGVBQVcsWUFBWTtBQUN2QixjQUFVLFlBQVksVUFBVTtBQUFBLEVBQ3BDLENBQUM7QUFDTDs7O0FDdEZBLFVBQVU7QUFDTixjQUFjO0FBQ2QsZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGxheWVyIH0gZnJvbSAnLi9wbGF5ZXInO1xuXG5leHBvcnQgZnVuY3Rpb24gYWlUdXJuKGFpUGxheWVyOiBQbGF5ZXIsIHRhcmdldFBsYXllcjogUGxheWVyKSB7XG4gICAgaWYgKGFpUGxheWVyLnBsYWNpbmdTaGlwcykge1xuICAgICAgICByZXR1cm5cbiAgICB9XG4gICAgZWxzZSBpZiAoIWFpUGxheWVyLnBsYWNpbmdTaGlwcykge1xuICAgICAgICBjb25zdCBsZWdhbE1vdmVzID0gdGFyZ2V0UGxheWVyLmJvYXJkLmdldFZhY2FudFRpbGVzKClcbiAgICAgICAgY29uc3QgY2hvb3NlVGFyZ2V0ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGVnYWxNb3Zlcy5sZW5ndGgpO1xuICAgICAgICBjb25zdCB0YXJnZXQgPSBsZWdhbE1vdmVzW2Nob29zZVRhcmdldF1cbiAgICAgICAgY29uc29sZS5sb2coYCR7dGFyZ2V0Lnh9LCAke3RhcmdldC55fWApXG4gICAgICAgIGFpUGxheWVyLnBsYWNlQXR0YWNrKHRhcmdldFBsYXllciwgdGFyZ2V0LngsIHRhcmdldC55KVxuICAgIH1cbn0iLCJleHBvcnQgaW50ZXJmYWNlIHNoaXBQcm9wcyB7XG4gICAgdHlwZTogc3RyaW5nLFxuICAgIHNpemU6IG51bWJlcixcbn1cblxuZXhwb3J0IGNsYXNzIFNoaXAge1xuICAgIHR5cGU6IHN0cmluZyA9ICdzbWFsbCdcbiAgICBzaXplOiBudW1iZXJcbiAgICBoaXRzOiBudW1iZXIgPSAwXG4gICAga2V5XG5cbiAgICBjb25zdHJ1Y3Rvcih0eXBlOiBzdHJpbmcsIHNpemU6IG51bWJlcikge1xuICAgICAgICB0aGlzLnNpemUgPSBzaXplO1xuICAgICAgICB0aGlzLnR5cGUgPSB0eXBlO1xuICAgICAgICB0aGlzLmtleSA9IGNyeXB0by5yYW5kb21VVUlEKClcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNTdW5rID0gKCkgPT4geyByZXR1cm4gdGhpcy5oaXRzID49IHRoaXMuc2l6ZSA/IHRydWUgOiBmYWxzZSB9O1xuXG4gICAgcHVibGljIHRha2VIaXQoKSB7XG4gICAgICAgIHRoaXMuaGl0cysrXG4gICAgfVxufSIsImltcG9ydCB7IFNoaXAgfSBmcm9tIFwiLi9zaGlwXCJcblxuZXhwb3J0IGNsYXNzIFRpbGUge1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHB1YmxpYyB4OiBudW1iZXIsXG4gICAgICAgIHB1YmxpYyB5OiBudW1iZXIsXG4gICAgICAgIHB1YmxpYyBvY2N1cGllZDogYm9vbGVhbiA9IGZhbHNlLFxuICAgICAgICBwdWJsaWMgaGl0OiBib29sZWFuID0gZmFsc2UsXG4gICAgICAgIHB1YmxpYyBzaGlwS2V5Pzogc3RyaW5nKSB7IH1cbn1cblxuZXhwb3J0IGNsYXNzIEdhbWVCb2FyZCB7XG4gICAgZ2FtZUJvYXJkOiBUaWxlW10gPSBbXVxuICAgIGFjdGl2ZVNoaXBzOiBTaGlwW10gPSBbXVxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHNpemU6IG51bWJlclxuICAgICkge1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHNpemU7IHgrKykge1xuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBzaXplOyB5KyspIHtcbiAgICAgICAgICAgICAgICB0aGlzLmdhbWVCb2FyZC5wdXNoKG5ldyBUaWxlKHgsIHkpKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcGxhY2VtZW50R3JpZChzdGFydFRpbGU6IFRpbGUsIHNoaXBTaXplOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgdGlsZXNUb0NoZWNrID0gW11cbiAgICAgICAgbGV0IGN1cnJlbnRUaWxlOiBUaWxlID0gc3RhcnRUaWxlXG4gICAgICAgIGlmICh0aWxlc1RvQ2hlY2subGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aWxlc1RvQ2hlY2sucHVzaChjdXJyZW50VGlsZSlcbiAgICAgICAgfVxuICAgICAgICB3aGlsZSAoc2hpcFNpemUgPiB0aWxlc1RvQ2hlY2subGVuZ3RoKSB7XG4gICAgICAgICAgICBsZXQgbmV3Q2hlY2tlZFRpbGUgPSB0aGlzLmdhbWVCb2FyZC5maW5kKChuZXdDaGVja2VkVGlsZSkgPT4gbmV3Q2hlY2tlZFRpbGUueCA9PT0gY3VycmVudFRpbGUueCAmJiBuZXdDaGVja2VkVGlsZS55ID09PSBjdXJyZW50VGlsZS55ICsgMSk7XG4gICAgICAgICAgICBpZiAobmV3Q2hlY2tlZFRpbGUpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50VGlsZSA9IG5ld0NoZWNrZWRUaWxlXG4gICAgICAgICAgICAgICAgdGlsZXNUb0NoZWNrLnB1c2goY3VycmVudFRpbGUpXG4gICAgICAgICAgICB9IGVsc2UgcmV0dXJuIFtdXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRpbGVzVG9DaGVjaztcbiAgICB9XG5cbiAgICBwdWJsaWMgcGxhY2VTaGlwKHR5cGU6IHN0cmluZywgc2l6ZTogbnVtYmVyLCBzdGFydFRpbGU6IFRpbGUpIHtcbiAgICAgICAgY29uc3QgcGxhY2VtZW50QXJlYSA9IHRoaXMucGxhY2VtZW50R3JpZChzdGFydFRpbGUsIHNpemUpXG4gICAgICAgIGlmIChwbGFjZW1lbnRBcmVhLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gZmFsc2UgfVxuICAgICAgICBlbHNlIGlmIChwbGFjZW1lbnRBcmVhLnNvbWUoKHRpbGUpID0+IHRpbGUub2NjdXBpZWQpKSB7IHJldHVybiBmYWxzZSB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc3Qgc2hpcFRvUGxhY2UgPSBuZXcgU2hpcCh0eXBlLCBzaXplKVxuICAgICAgICAgICAgcGxhY2VtZW50QXJlYS5mb3JFYWNoKCh0aWxlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGlsZS5vY2N1cGllZCA9IHRydWVcbiAgICAgICAgICAgICAgICB0aWxlLnNoaXBLZXkgPSBzaGlwVG9QbGFjZS5rZXlcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZVNoaXBzLnB1c2goc2hpcFRvUGxhY2UpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHVibGljIHJlY2VpdmVBdHRhY2soYXR0YWNrZWRUaWxlOiBUaWxlKSB7XG4gICAgICAgIGlmIChhdHRhY2tlZFRpbGUuaGl0KSB7IHJldHVybiBmYWxzZSB9XG4gICAgICAgIGVsc2UgaWYgKGF0dGFja2VkVGlsZS5vY2N1cGllZCkge1xuICAgICAgICAgICAgYXR0YWNrZWRUaWxlLmhpdCA9IHRydWVcbiAgICAgICAgICAgIGlmIChhdHRhY2tlZFRpbGUuc2hpcEtleSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGF0dGFja2VkU2hpcCA9IHRoaXMuZmluZFNoaXBGcm9tS2V5KGF0dGFja2VkVGlsZS5zaGlwS2V5KVxuICAgICAgICAgICAgICAgIGlmIChhdHRhY2tlZFNoaXApIGF0dGFja2VkU2hpcC50YWtlSGl0KClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGF0dGFja2VkVGlsZS5oaXQgPSB0cnVlXG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgcHVibGljIGZpbmRUaWxlKHg6IG51bWJlciwgeTogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdhbWVCb2FyZC5maW5kKCh0aWxlKSA9PiB0aWxlLnggPT0geCAmJiB0aWxlLnkgPT0geSlcbiAgICB9XG5cbiAgICBmaW5kU2hpcEZyb21LZXkoa2V5VG9GaW5kOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZm91bmRTaGlwID0gdGhpcy5hY3RpdmVTaGlwcy5maW5kKChzaGlwKSA9PiBzaGlwLmtleSA9PT0ga2V5VG9GaW5kKVxuICAgICAgICByZXR1cm4gZm91bmRTaGlwXG4gICAgfVxuXG4gICAgcHVibGljIGNoZWNrSWZBbGxTdW5rKCkge1xuICAgICAgICAvLyBjb25zdCBvY2N1cGllZFRpbGVzID0gdGhpcy5nYW1lQm9hcmQuZmlsdGVyKCh0aWxlKSA9PiB0aWxlLm9jY3VwaWVkKVxuICAgICAgICByZXR1cm4gdGhpcy5hY3RpdmVTaGlwcy5ldmVyeSgoc2hpcCkgPT4gc2hpcC5pc1N1bmsoKSlcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0VmFjYW50VGlsZXMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdhbWVCb2FyZC5maWx0ZXIoKHRpbGUpID0+ICF0aWxlLmhpdCk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzT2NjdXBpZWQoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5maW5kVGlsZSh4LCB5KVxuICAgICAgICBpZiAodGFyZ2V0KSB0YXJnZXQub2NjdXBpZWQgPyB0cnVlIDogZmFsc2VcbiAgICB9XG5cbn0iLCJpbXBvcnQgeyBHYW1lQm9hcmQgfSBmcm9tIFwiLi9nYW1lYm9hcmRcIjtcbmltcG9ydCB7IHNoaXBQcm9wcywgU2hpcCB9IGZyb20gXCIuL3NoaXBcIjtcblxuZXhwb3J0IGNsYXNzIFBsYXllciB7XG4gICAgc2hpcEJlaW5nUGxhY2VkPzogc2hpcFByb3BzXG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHVibGljIG5hbWU6IHN0cmluZyxcbiAgICAgICAgcHVibGljIGh1bWFuOiBib29sZWFuID0gdHJ1ZSxcbiAgICAgICAgcHVibGljIHRha2luZ1R1cm4gPSB0cnVlLFxuICAgICAgICBwdWJsaWMgc2hpcHNBdmFpbGFibGU6IHNoaXBQcm9wc1tdID0gW3sgdHlwZTogJ3RpbnknLCBzaXplOiAxIH0sIHsgdHlwZTogJ3NtYWxsJywgc2l6ZTogMiB9XSxcbiAgICAgICAgcHVibGljIGJvYXJkID0gbmV3IEdhbWVCb2FyZCg5KSxcbiAgICAgICAgcHVibGljIHBsYWNpbmdTaGlwcyA9IHRydWUsXG4gICAgKSB7IH1cblxuICAgIHB1YmxpYyBwbGFjZUF0dGFjayhlbmVteVBsYXllcjogUGxheWVyLCB4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgICAgICBjb25zdCB0YXJnZXQgPSBlbmVteVBsYXllci5ib2FyZC5maW5kVGlsZSh4LCB5KVxuICAgICAgICBpZiAodGFyZ2V0ICYmICF0YXJnZXQuaGl0KSB7XG4gICAgICAgICAgICBlbmVteVBsYXllci5ib2FyZC5yZWNlaXZlQXR0YWNrKHRhcmdldCk7XG4gICAgICAgICAgICB0aGlzLnRha2luZ1R1cm4gPSBmYWxzZVxuICAgICAgICAgICAgZW5lbXlQbGF5ZXIuc2V0VHVybigpXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0VHVybigpIHtcbiAgICAgICAgdGhpcy50YWtpbmdUdXJuID0gdHJ1ZVxuICAgIH1cblxuICAgIHB1YmxpYyBwbGFjZVNoaXAoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKHRoaXMucGxhY2luZ1NoaXBzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zaGlwc0F2YWlsYWJsZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNoaXBCZWluZ1BsYWNlZCA9IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIHRoaXMucGxhY2luZ1NoaXBzID0gZmFsc2VcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHNoaXBUb1BsYWNlID0gdGhpcy5zaGlwc0F2YWlsYWJsZS5wb3AoKVxuICAgICAgICAgICAgdGhpcy5zaGlwQmVpbmdQbGFjZWQgPSBzaGlwVG9QbGFjZVxuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5ib2FyZC5maW5kVGlsZSh4LCB5KVxuICAgICAgICAgICAgaWYgKHRhcmdldCAmJiBzaGlwVG9QbGFjZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYm9hcmQucGxhY2VTaGlwKHNoaXBUb1BsYWNlLnR5cGUsIHNoaXBUb1BsYWNlLnNpemUsIHRhcmdldClcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGlwc0F2YWlsYWJsZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaGlwQmVpbmdQbGFjZWQgPSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGFjaW5nU2hpcHMgPSBmYWxzZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlXG4gICAgfVxufSIsImltcG9ydCB7IGFpVHVybiB9IGZyb20gXCIuL2FpXCI7XG5pbXBvcnQgeyBQbGF5ZXIgfSBmcm9tIFwiLi9wbGF5ZXJcIjtcbmV4cG9ydCBsZXQgUDE6IFBsYXllciA9IG5ldyBQbGF5ZXIoXCJQMVwiKVxuZXhwb3J0IGxldCBQMjogUGxheWVyID0gbmV3IFBsYXllcihcIlAyXCIsIGZhbHNlLCBmYWxzZSlcbmV4cG9ydCBsZXQgd2lubmVyID0gXCJUQkNcIlxuZXhwb3J0IGxldCBnYW1lSW5QbGF5ID0gdHJ1ZVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBHYW1lKCkge1xuICAgIFAxID0gbmV3IFBsYXllcihcIlAxXCIpXG4gICAgUDIgPSBuZXcgUGxheWVyKFwiUDJcIiwgZmFsc2UsIGZhbHNlKVxuICAgIGdhbWVJblBsYXkgPSB0cnVlXG5cbiAgICAvLyB0ZW1wb3Jhcnkgc2hpcCBwbGFjZW1lbnQgYW5kIHNldHVwXG4gICAgUDIucGxhY2VTaGlwKDEsIDEpXG4gICAgUDIucGxhY2VTaGlwKDIsIDIpXG4gICAgUDIucGxhY2luZ1NoaXBzID0gZmFsc2Vcbn1cblxuY29uc3QgZ2V0Q3VycmVudFBsYXllciA9ICgpID0+IHtcbiAgICBpZiAoUDEudGFraW5nVHVybiAmJiAhUDIudGFraW5nVHVybikgeyByZXR1cm4gUDEgfVxuICAgIGlmIChQMi50YWtpbmdUdXJuICYmICFQMS50YWtpbmdUdXJuKSB7IHJldHVybiBQMiB9XG59XG5cbmNvbnN0IGdldEVuZW15UGxheWVyID0gKCkgPT4ge1xuICAgIGlmIChQMS50YWtpbmdUdXJuICYmICFQMi50YWtpbmdUdXJuKSB7IHJldHVybiBQMiB9XG4gICAgaWYgKFAyLnRha2luZ1R1cm4gJiYgIVAxLnRha2luZ1R1cm4pIHsgcmV0dXJuIFAxIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFAxU2hpcHNBdmFpbGFibGUoKSB7XG4gICAgcmV0dXJuIFAxLnNoaXBzQXZhaWxhYmxlXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQMlNoaXBzQXZhaWxhYmxlKCkge1xuICAgIHJldHVybiBQMi5zaGlwc0F2YWlsYWJsZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlQ2xpY2soYm9hcmROYW1lOiBzdHJpbmcsIHg6IG51bWJlciwgeTogbnVtYmVyKSB7XG4gICAgY29uc3QgY3VycmVudFBsYXllcjogUGxheWVyID0gZ2V0Q3VycmVudFBsYXllcigpIGFzIFBsYXllclxuICAgIGNvbnN0IGVuZW15UGxheWVyOiBQbGF5ZXIgPSBnZXRFbmVteVBsYXllcigpIGFzIFBsYXllclxuICAgIGlmIChib2FyZE5hbWUgPT09IGN1cnJlbnRQbGF5ZXIubmFtZSkge1xuICAgICAgICBpZiAoIWN1cnJlbnRQbGF5ZXIucGxhY2luZ1NoaXBzKSB7IHJldHVybiBmYWxzZSB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY3VycmVudFBsYXllci5wbGFjZVNoaXAoeCwgeSlcbiAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGJvYXJkTmFtZSA9PT0gZW5lbXlQbGF5ZXIubmFtZSAmJiAhY3VycmVudFBsYXllci5wbGFjaW5nU2hpcHMpIHtcbiAgICAgICAgaWYgKGVuZW15UGxheWVyLmJvYXJkLmZpbmRUaWxlKHgsIHkpPy5oaXQpIHJldHVybiBmYWxzZVxuICAgICAgICBjdXJyZW50UGxheWVyLnBsYWNlQXR0YWNrKGVuZW15UGxheWVyLCB4LCB5KVxuICAgICAgICBsZXQgaXNXaW5uZXIgPSBjaGVja1dpbm5lcigpXG4gICAgICAgIGlmIChnYW1lSW5QbGF5ICYmICFlbmVteVBsYXllci5odW1hbikge1xuICAgICAgICAgICAgYWlUdXJuKGVuZW15UGxheWVyLCBjdXJyZW50UGxheWVyKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgfVxufVxuXG5mdW5jdGlvbiBjaGVja1dpbm5lcigpIHtcbiAgICBpZiAoIVAxLmJvYXJkLmNoZWNrSWZBbGxTdW5rKCkgJiYgIVAyLmJvYXJkLmNoZWNrSWZBbGxTdW5rKCkpIHtcbiAgICAgICAgZ2FtZUluUGxheSA9IHRydWVcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIGVsc2UgaWYgKFAxLmJvYXJkLmNoZWNrSWZBbGxTdW5rKCkgPT09IHRydWUpIHtcbiAgICAgICAgd2lubmVyID0gUDIubmFtZVxuICAgICAgICBnYW1lSW5QbGF5ID0gZmFsc2VcbiAgICAgICAgcmV0dXJuIHdpbm5lclxuICAgIH1cbiAgICBlbHNlIGlmIChQMi5ib2FyZC5jaGVja0lmQWxsU3VuaygpID09PSB0cnVlKSB7XG4gICAgICAgIHdpbm5lciA9IFAxLm5hbWVcbiAgICAgICAgZ2FtZUluUGxheSA9IGZhbHNlXG4gICAgICAgIHJldHVybiB3aW5uZXJcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGdhbWVJblBsYXkgPSB0cnVlXG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFAxQm9hcmQoKSB7XG4gICAgcmV0dXJuIFAxLmJvYXJkLmdhbWVCb2FyZFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UDJCb2FyZCgpIHtcbiAgICByZXR1cm4gUDIuYm9hcmQuZ2FtZUJvYXJkXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTaGlwQmVpbmdQbGFjZWQoKSB7XG4gICAgY29uc3QgY3VycmVudFBsYXllciA9IGdldEN1cnJlbnRQbGF5ZXIoKVxuICAgIGlmIChjdXJyZW50UGxheWVyICYmIGN1cnJlbnRQbGF5ZXIucGxhY2luZ1NoaXBzKSByZXR1cm4gY3VycmVudFBsYXllci5zaGlwQmVpbmdQbGFjZWRcbn0iLCJpbXBvcnQgKiBhcyBnYW1lIGZyb20gXCIuL2dhbWVcIjtcbmltcG9ydCB7IFRpbGUgfSBmcm9tIFwiLi9nYW1lYm9hcmRcIjtcblxuXG5jb25zdCBQMUZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJQMUZyYW1lXCIpIGFzIEhUTUxEaXZFbGVtZW50XG5jb25zdCBQMkZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJQMkZyYW1lXCIpIGFzIEhUTUxEaXZFbGVtZW50XG5cbmZ1bmN0aW9uIGNyZWF0ZVRpbGUob3duZXI6IHN0cmluZywgdGlsZTogVGlsZSkge1xuICAgIGNvbnN0IG5ld1RpbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICAgIG5ld1RpbGUuaWQgPSBgJHtvd25lcn0tJHt0aWxlLnh9LSR7dGlsZS55fWBcbiAgICBpZiAob3duZXIgPT09IFwiUDFcIiAmJiB0aWxlLm9jY3VwaWVkICYmICF0aWxlLmhpdCkge1xuICAgICAgICBuZXdUaWxlLmNsYXNzTmFtZSA9IFwidGlsZSBteXNoaXBcIlxuICAgIH1cbiAgICBlbHNlIGlmICh0aWxlLmhpdCAmJiAhdGlsZS5vY2N1cGllZCkge1xuICAgICAgICBuZXdUaWxlLmNsYXNzTmFtZSA9IFwidGlsZSBtaXNzXCJcbiAgICAgICAgbmV3VGlsZS5pbm5lclRleHQgPSBcInhcIlxuICAgIH1cbiAgICBlbHNlIGlmICh0aWxlLmhpdCAmJiB0aWxlLm9jY3VwaWVkKSB7XG4gICAgICAgIG5ld1RpbGUuY2xhc3NOYW1lID0gXCJ0aWxlIGhpdFwiXG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBuZXdUaWxlLmNsYXNzTmFtZSA9IFwidGlsZVwiXG4gICAgfVxuICAgIG5ld1RpbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgIGlmIChnYW1lLmdhbWVJblBsYXkpIHtcbiAgICAgICAgICAgIGdhbWUuaGFuZGxlQ2xpY2sob3duZXIsIHRpbGUueCwgdGlsZS55KVxuICAgICAgICAgICAgcmVmcmVzaEJvYXJkcygpXG4gICAgICAgICAgICByZWZyZXNoSGFyYm91cnMoKVxuICAgICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gbmV3VGlsZVxufVxuXG5mdW5jdGlvbiBjbGlja1JlZihpZFN0cmluZzogc3RyaW5nKSB7XG4gICAgY29uc3QgcGFyYW1zID0gaWRTdHJpbmcuc3BsaXQoJy0nKVxuICAgIHJldHVybiBwYXJhbXNcbn1cblxuZnVuY3Rpb24gcmVmcmVzaFRpbGUodGlsZTogVGlsZSkge1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWZyZXNoQm9hcmRzKCkge1xuICAgIGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ25vbmUnO1xuXG4gICAgY29uc3QgUDFCb2FyZCA9IGdhbWUuZ2V0UDFCb2FyZCgpXG4gICAgY29uc3QgUDJCb2FyZCA9IGdhbWUuZ2V0UDJCb2FyZCgpXG5cbiAgICAvLyBjcmVhdGUgRE9NIGVsZW1lbnRzIGZvciBQMSBib2FyZFxuICAgIFAxRnJhbWUuaW5uZXJIVE1MID0gJydcbiAgICBQMUJvYXJkLmZvckVhY2godGlsZSA9PiB7XG4gICAgICAgIGNvbnN0IG5ld1RpbGUgPSBjcmVhdGVUaWxlKFwiUDFcIiwgdGlsZSlcbiAgICAgICAgUDFGcmFtZS5hcHBlbmRDaGlsZChuZXdUaWxlKVxuICAgIH0pXG5cbiAgICAvLyBjcmVhdGUgRE9NIGVsZW1lbnRzIGZvciBQMiBib2FyZFxuICAgIFAyRnJhbWUuaW5uZXJIVE1MID0gJydcbiAgICBQMkJvYXJkLmZvckVhY2godGlsZSA9PiB7XG4gICAgICAgIGNvbnN0IG5ld1RpbGUgPSBjcmVhdGVUaWxlKFwiUDJcIiwgdGlsZSlcbiAgICAgICAgUDJGcmFtZS5hcHBlbmRDaGlsZChuZXdUaWxlKVxuICAgIH0pXG4gICAgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnYXV0byc7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlZnJlc2hIYXJib3VycygpIHtcbiAgICBjb25zdCBQMVNoaXBzID0gZ2FtZS5nZXRQMVNoaXBzQXZhaWxhYmxlKClcbiAgICBjb25zdCBQMlNoaXBzID0gZ2FtZS5nZXRQMlNoaXBzQXZhaWxhYmxlKClcbiAgICBjb25zdCBQMUhhcmJvdXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIlAxSGFyYm91clwiKSBhcyBIVE1MRGl2RWxlbWVudFxuICAgIFAxSGFyYm91ci5pbm5lckhUTUwgPSAnPGg0PkhhcmJvdXIgKHNoaXBzIHRvIHBsYWNlKTwvaDQ+J1xuICAgIGNvbnN0IFAySGFyYm91ciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiUDJIYXJib3VyXCIpIGFzIEhUTUxEaXZFbGVtZW50XG4gICAgUDJIYXJib3VyLmlubmVySFRNTCA9ICc8aDQ+SGFyYm91cjwvaDQ+J1xuICAgIFAxU2hpcHMuZm9yRWFjaCgoc2hpcCkgPT4ge1xuICAgICAgICBjb25zdCBuZXdTaGlwRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgICAgICAgbmV3U2hpcERpdi5pbm5lclRleHQgPSBgJHtzaGlwLnR5cGV9ICgke3NoaXAuc2l6ZX0pYFxuICAgICAgICBpZiAoc2hpcCA9PSBnYW1lLmdldFNoaXBCZWluZ1BsYWNlZCgpKSB7XG4gICAgICAgICAgICBuZXdTaGlwRGl2LmNsYXNzTmFtZSA9IFwiaGFyYm91clNoaXAgY3VycmVudFNoaXBcIlxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgbmV3U2hpcERpdi5jbGFzc05hbWUgPSBcImhhcmJvdXJTaGlwXCJcbiAgICAgICAgfVxuICAgICAgICBQMUhhcmJvdXIuYXBwZW5kQ2hpbGQobmV3U2hpcERpdilcbiAgICB9KVxuICAgIFAyU2hpcHMuZm9yRWFjaCgoc2hpcCkgPT4ge1xuICAgICAgICBjb25zdCBuZXdTaGlwRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgICAgICAgbmV3U2hpcERpdi5pbm5lclRleHQgPSBgJHtzaGlwLnR5cGV9ICgke3NoaXAuc2l6ZX0pYFxuICAgICAgICBuZXdTaGlwRGl2LmNsYXNzTmFtZSA9IFwiaGFyYm91clNoaXBcIlxuICAgICAgICBQMkhhcmJvdXIuYXBwZW5kQ2hpbGQobmV3U2hpcERpdilcbiAgICB9KVxufVxuXG5mdW5jdGlvbiBzaGlwU2hhZG93KGNsaWNrZWRUaWxlOiBUaWxlKSB7XG4gICAgY29uc3Qgc2hpcFRvUGxhY2UgPSBnYW1lLmdldFNoaXBCZWluZ1BsYWNlZCgpXG5cblxufSIsImltcG9ydCAqIGFzIERPTSBmcm9tIFwiLi9jb250cm9sXCJcbmltcG9ydCB7IHNldHVwR2FtZSB9IGZyb20gXCIuL2dhbWVcIlxuXG5zZXR1cEdhbWUoKVxuRE9NLnJlZnJlc2hCb2FyZHMoKVxuRE9NLnJlZnJlc2hIYXJib3VycygpIl19